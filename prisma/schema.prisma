// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  EXAMINER
  CANDIDATE
  ADMIN
}

enum ExamStatus {
  DRAFT
  PUBLISHED
  RUNNING
  ENDED
  ARCHIVED
}

enum ExamAttemptStatus {
  CREATED
  IN_PROGRESS
  SUBMITTED
  TERMINATED
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  password     String
  refreshToken String?
  role         Role          @default(CANDIDATE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime?     @updatedAt
  examAttempts ExamAttempt[]
  createdExams Exam[]        @relation("ExamCreatedBy")
  updatedExams Exam[]        @relation("ExamUpdatedBy")
}

model Option {
  id         String  @default(uuid())
  questionId String
  content    String
  isCorrect  Boolean @default(false)

  question Question @relation(fields: [questionId], references: [id])

  @@id([id, questionId])
}

model Question {
  id      String         @id @default(uuid())
  content String
  exams   ExamQuestion[]

  options Option[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime?       @updatedAt
  attemptAnswers AttemptAnswer[]
}

model ExamAttempt {
  id     String @id @default(uuid())
  userId String
  examId String
  status ExamAttemptStatus @default(CREATED)

  // Exam snapshot at attempt creation
  examTitle       String?
  examDescription String?
  duration        Int?
  passScore       Int?
  startAt         DateTime?
  endAt           DateTime?

  score      Int?
  startedAt  DateTime  @default(now())
  finishedAt DateTime?

  user User @relation(fields: [userId], references: [id])
  exam Exam @relation(fields: [examId], references: [id])

  answers AttemptAnswer[]
  questions ExamAttemptQuestion[]

  @@unique([userId, examId])
}

model ExamAttemptQuestion {
  id         String @id @default(uuid())
  attemptId  String
  questionId String
  order      Int?
  score      Float? @default(1)

  // Question snapshot
  content String

  attempt  ExamAttempt @relation(fields: [attemptId], references: [id])
  options  ExamAttemptOption[]

  @@unique([attemptId, order])
}

model ExamAttemptOption {
  id         String @id @default(uuid())
  questionId String
  content    String
  isCorrect  Boolean @default(false)

  question ExamAttemptQuestion @relation(fields: [questionId], references: [id])
}

model AttemptAnswer {
  attemptId  String
  questionId String
  optionId   String

  attempt  ExamAttempt @relation(fields: [attemptId], references: [id])
  question Question    @relation(fields: [questionId], references: [id])

  @@id([attemptId, questionId])
}

model Exam {
  id          String     @id @default(uuid())
  title       String
  description String?
  passScore   Int
  status      ExamStatus @default(DRAFT)
  assignees   String[]   @default([]) // List of email addresses assigned to take this exam
  startAt     DateTime?
  endAt       DateTime?

  questions ExamQuestion[]
  attempts  ExamAttempt[]

  createdById String
  createdBy   User    @relation("ExamCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("ExamUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model ExamQuestion {
  examId     String
  questionId String
  order      Int?
  score      Float? @default(1)

  exam     Exam     @relation(fields: [examId], references: [id])
  question Question @relation(fields: [questionId], references: [id])

  @@id([examId, questionId])
  @@unique([examId, order])
}
